<div 
  data-controller="event-form"
  data-event-form-preload-tickets-value='<%= raw(@event.tickets.map { |t|
    { id: t.id, name: t.name, price: t.price.to_f.to_s, quantity_total: t.quantity_total }
    }.to_json) %>' 
  class="flex min-h-full flex-col w-full justify-center px-6 py-12 lg:px-8">
  <div class="sm:mx-auto sm:w-full sm:max-w-sm">
    <h2 class="mt-4 text-center text-2xl/9 font-bold tracking-tight text-black">Edit Event</h2>
  </div>

  <div class="mt-8 sm:mx-auto sm:w-full sm:max-w-sm">
    <%= form_with model: @event, local: true do |f| %>
      <% if @event.errors[:base].any? %>
        <div class="mb-4 rounded-md bg-red-50 border border-red-200 p-3 text-sm text-red-700">
          <%= @event.errors[:base].join(", ") %>
        </div>
      <% end %>

      <div class="space-y-6">

        <!-- Title -->
        <div>
          <%= f.label :title, "Title", class: "block text-sm/6 font-medium text-black" %>
          <div class="mt-2">
            <%= f.text_field :title, class: "block border w-full rounded-md bg-white/5 px-3 py-1.5 text-base text-black placeholder:text-gray-500 sm:text-sm/6" %>
          </div>
        </div>

        <!-- Location -->
        <div>
          <%= f.label :location, "Location", class: "block text-sm/6 font-medium text-black" %>
          <div class="mt-2">
            <%= f.text_field :location, class: "block border w-full rounded-md bg-white/5 px-3 py-1.5 text-base text-black placeholder:text-gray-500 sm:text-sm/6" %>
          </div>
        </div>

        <!-- Start/End Dates -->
        <div>
          <%= f.label :starts_at, "Event Start Date", class: "block text-sm/6 font-medium text-black" %>
          <div class="mt-2">
            <%= f.date_field :starts_at,
                class: "block w-full rounded-md border bg-white/5 px-3 py-1.5 text-base text-black placeholder:text-gray-500 focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 sm:text-sm/6" %>
          </div>
        </div>

        <div>
          <%= f.label :ends_at, "Event End Date", class: "block text-sm/6 font-medium text-black" %>
          <div class="mt-2">
            <%= f.date_field :ends_at,
                class: "block w-full rounded-md border bg-white/5 px-3 py-1.5 text-base text-black placeholder:text-gray-500 focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 sm:text-sm/6" %>
          </div>
        </div>

        <!-- Category -->
        <div>
          <%= f.label :category_id, "Category", class: "block text-sm/6 font-medium text-black" %>
          <div class="mt-2">
            <%= f.collection_select :category_id,
                (@categories || Category.all),
                :id,
                :name,
                { include_blank: "Select category" },
                class: "block w-full rounded-md border bg-white/5 px-3 py-1.5 text-base text-black placeholder:text-gray-500 focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 sm:text-sm/6" %>
          </div>
        </div>

        <!-- Published -->
        <div>
          <%= f.label :published, "Is Published", class: "block text-sm/6 font-medium text-black" %>
          <div class="flex items-center gap-3">
            <%= f.check_box :published, checked: @event.status == 'published' %>
            <span class="text-sm text-gray-700">
              Make this event visible to users
            </span>
          </div>
        </div>

        <!-- Cancelled -->
        <div>
          <%= f.label :cancelled, "Cancel Event", class: "block text-sm/6 font-medium text-black" %>
          <div class="flex items-center gap-3">
            <%= f.check_box :cancelled, checked: @event.status == 'cancelled' %>
            <span class="text-sm text-gray-700">
              Make this event cancelled
            </span>
          </div>
        </div>

      </div>

      <!-- ================= TICKETS SECTION ================= -->
      <div class="mt-10 border-t pt-6">
        <div class="flex items-center justify-between">
          <h3 class="text-lg font-semibold text-black">üéü Tickets</h3>

          <button
            type="button"
            data-action="click->event-form#openDrawer"
            class="rounded-md border px-3 py-1.5 text-sm font-medium hover:bg-gray-50"
          >
            Manage Tickets
          </button>
        </div>

        <!-- Empty state -->
        <div
          data-event-form-target="emptyState"
          class="mt-3 rounded-md bg-yellow-50 border border-yellow-200 p-3 text-sm text-yellow-800 <%= 'hidden' if @event.tickets.any? %>"
        >
          ‚ö†Ô∏è No tickets added yet. You must add at least one ticket before saving the event.
        </div>

        <!-- Ticket summary list -->
        <div data-event-form-target="ticketsContainer"></div>

      </div>

      <!-- Hidden fields for Rails -->
      <div data-event-form-target="hiddenFields"></div>

      <!-- Submit -->
      <div class="mt-6 flex justify-center">
        <%= f.submit "Update Event",
            data: { event_form_target: "submit" },
            class: "w-1/2 rounded-md bg-indigo-500 px-3 py-1.5 text-sm/6 font-semibold text-black hover:bg-indigo-400 disabled:opacity-40 disabled:cursor-not-allowed" %>
      </div>
    <% end %>
  </div>

  <!-- ================= DRAWER ================= -->
  <div
    data-event-form-target="drawer"
    class="hidden fixed inset-y-0 left-0 z-50 w-[420px] bg-white shadow-xl border-r"
  >
    <div class="flex items-center justify-between p-4 border-b">
      <h3 class="font-semibold text-lg">Manage Tickets</h3>

      <button
        type="button"
        data-action="click->event-form#closeDrawer"
        class="text-gray-500 hover:text-black"
      >
        ‚úï
      </button>
    </div>

    <div class="p-4 space-y-4">

      <div>
        <label class="block text-sm font-medium">Name</label>
        <input
          data-event-form-target="nameInput"
          class="mt-1 w-full rounded-md border px-3 py-1.5"
        >
      </div>

      <div>
        <label class="block text-sm font-medium">Price (‚Ç¨)</label>
        <input
          type="number"
          step="0.01"
          data-event-form-target="priceInput"
          class="mt-1 w-full rounded-md border px-3 py-1.5"
        >
      </div>

      <div>
        <label class="block text-sm font-medium">Quantity</label>
        <input
          type="number"
          data-event-form-target="quantityInput"
          class="mt-1 w-full rounded-md border px-3 py-1.5"
        >
      </div>

      <button
        type="button"
        data-action="click->event-form#addTicket"
        class="w-full rounded-md bg-indigo-500 px-3 py-1.5 text-sm font-semibold text-black hover:bg-indigo-400"
      >
        Add / Update Ticket
      </button>

    </div>
  </div>
</div>
